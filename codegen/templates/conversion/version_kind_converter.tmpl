package conversion

import (
	"github.com/grafana/grafana-app-sdk/resource"

	{{ .VersionPackage }} "{{ .VersionPackagePath }}"
	{{ .InternalPackage }} "{{ .InternalPackagePath }}"
)

// Set one or both of these variables to a non-nil function to override the generated default behavior.
// Since this file is auto-generated, set these functions in a separate file which will not be overwritten by the codegen.
var (
	{{ .VersionPackage }}{{ .KindTypeName }}ToInternalFunc   func(resource.ObjectOrRaw) (*TypedObjectOrRaw[*{{ .VersionPackage }}.{{ .KindTypeName }}], error)
	{{ .VersionPackage }}{{ .KindTypeName }}FromInternalFunc func(TypedObjectOrRaw[*{{ .InternalPackage }}.{{ .KindTypeName }}]) (*resource.ObjectOrRaw, error)
)

func Convert{{ .ExportField .VersionPackage }}{{ .KindTypeName }}ToInternal(raw resource.ObjectOrRaw) (*resource.ObjectOrRaw, error) {
	if {{ .VersionPackage }}{{ .KindTypeName }}ToInternalFunc != nil {
		res, err := {{ .VersionPackage }}{{ .KindTypeName }}ToInternalFunc(raw)
		if err != nil {
			return nil, err
		}
		return &resource.ObjectOrRaw{
			Raw:      res.Raw,
			Encoding: res.Encoding,
			Object:   res.Object,
		}, nil
	}

	// Unmarshal the object if necessary
	obj, err := getObjectFromRawType[*{{ .VersionPackage }}.{{ .KindTypeName }}](raw, {{ .VersionPackage }}.{{ .KindTypeName }}Kind())
	if err != nil {
		return nil, err
	}

	// Do the conversion
	// TODO
	return &resource.ObjectOrRaw{
		Object: obj,
	}, nil
}

func ConvertInternalTo{{ .ExportField .VersionPackage }}{{ .KindTypeName}}(raw resource.ObjectOrRaw) (*resource.ObjectOrRaw, error) {
	if {{ .VersionPackage }}{{ .KindTypeName }}FromInternalFunc != nil {
		typed := TypedObjectOrRaw[*{{ .InternalPackage }}.{{ .KindTypeName }}]{
			Raw:      raw.Raw,
			Encoding: raw.Encoding,
		}
		if raw.Object != nil {
			cast, ok := raw.Object.(*{{ .InternalPackage }}.{{ .KindTypeName }})
			if ok {
				typed.Object = cast
			}
		}
		return {{ .VersionPackage }}{{ .KindTypeName }}FromInternalFunc(typed)
	}

	// Unmarshal the object if necessary
	obj, err := getObjectFromRawType[*{{ .InternalPackage }}.{{ .KindTypeName }}](raw, {{ .InternalPackage }}.{{ .KindTypeName }}Kind())
	if err != nil {
		return nil, err
	}

	// Do the conversion
	// TODO
	return &resource.ObjectOrRaw{
		Object: obj,
	}, nil
}
